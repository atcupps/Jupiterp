name: Team Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'site/**'

jobs:
  deploy-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare deployment metadata
        id: prepare
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          AUTHORIZED_PR_AUTHORS: ${{ secrets.AUTHORIZED_PR_AUTHORS }}
        run: |
          python - <<'PY'
          import os
          from deployment.preview import sanitize_author, parse_authorized

          author = os.environ["PR_AUTHOR"]
          authorized = parse_authorized(os.environ.get("AUTHORIZED_PR_AUTHORS", ""))
          allowed = "yes" if author.lower() in authorized else "no"
          sanitized = sanitize_author(author)

          with open(os.environ["GITHUB_OUTPUT"], "w") as f:
              f.write(f"author={author}\n")
              f.write(f"sanitized_author={sanitized}\n")
              f.write(f"allowed={allowed}\n")
          PY

      - name: Install gcloud CLI
        if: steps.prepare.outputs.allowed == 'yes'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Record deployment start timestamp
        if: steps.prepare.outputs.allowed == 'yes'
        run: echo "DEPLOY_START=$(date -u +'%Y-%m-%d %H:%M:%SZ')" >> $GITHUB_ENV

      - name: Comment that deployment is starting
        if: steps.prepare.outputs.allowed == 'yes'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deployment
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            **Preview deployment for @${{ steps.prepare.outputs.author }}**

            Status: starting ⏳

            Service: `${{ steps.prepare.outputs.sanitized_author }}`

            Preview URL (when ready): https://${{ steps.prepare.outputs.sanitized_author }}.jupiterp.com

            Started at (UTC): `${{ env.DEPLOY_START }}`

      - name: Deploy preview
        id: deploy
        if: steps.prepare.outputs.allowed == 'yes'
        continue-on-error: true
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          PR_AUTHOR: ${{ steps.prepare.outputs.author }}
          AUTHORIZED_PR_AUTHORS: ${{ secrets.AUTHORIZED_PR_AUTHORS }}
        run: python deployment/preview.py

      - name: Record deployment end timestamp
        if: steps.prepare.outputs.allowed == 'yes'
        run: echo "DEPLOY_END=$(date -u +'%Y-%m-%d %H:%M:%SZ')" >> $GITHUB_ENV

      - name: Comment that deployment succeeded
        if: steps.prepare.outputs.allowed == 'yes' && steps.deploy.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deployment
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            **Preview updated for @${{ steps.prepare.outputs.author }} ✅**

            Preview URL: https://${{ steps.prepare.outputs.sanitized_author }}.jupiterp.com

            Started at (UTC): `${{ env.DEPLOY_START }}`
            Completed at (UTC): `${{ env.DEPLOY_END }}`

      - name: Comment that deployment failed
        if: steps.prepare.outputs.allowed == 'yes' && steps.deploy.outcome != 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deployment
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          message: |
            **Preview deployment failed for @${{ steps.prepare.outputs.author }} ❌**

            Preview URL (may be stale): https://${{ steps.prepare.outputs.sanitized_author }}.jupiterp.com

            Started at (UTC): `${{ env.DEPLOY_START }}`
            Completed at (UTC): `${{ env.DEPLOY_END }}`

            Check the workflow logs for details, then re-run the job once fixed.

      - name: Fail workflow when deployment fails
        if: steps.prepare.outputs.allowed == 'yes' && steps.deploy.outcome != 'success'
        run: |
          echo "Deployment failed; marking job as failed after commenting."
          exit 1
